# üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @OptionalUser()

## –û–±–∑–æ—Ä

–î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ `@OptionalUser()` –±—ã–ª —Å–æ–∑–¥–∞–Ω —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö.

## üöÄ –¢–µ—Å—Ç–æ–≤—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç

### URL

```
GET /test-optional-user
```

### –û–ø–∏—Å–∞–Ω–∏–µ

–≠–Ω–¥–ø–æ–∏–Ω—Ç –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, –±—ã–ª –ª–∏ –∏–∑–≤–ª–µ—á–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ —Ç–æ–∫–µ–Ω–∞ –∏ –µ–≥–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

### –û—Ç–≤–µ—Ç

#### –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:

```json
{
  "message": "–¢–µ—Å—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @OptionalUser()",
  "user": {
    "id": "cce0b3a9-f482-477e-8dda-6b4eb5b7945f",
    "username": "TestUser",
    "email": "test@example.com"
  },
  "isAuthenticated": true
}
```

#### –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:

```json
{
  "message": "–¢–µ—Å—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @OptionalUser()",
  "user": null,
  "isAuthenticated": false
}
```

## üîß –°–ø–æ—Å–æ–±—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ë–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

```bash
curl -X GET http://localhost:3000/test-optional-user
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "message": "–¢–µ—Å—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @OptionalUser()",
  "user": null,
  "isAuthenticated": false
}
```

### 2. –° Bearer —Ç–æ–∫–µ–Ω–æ–º –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ

```bash
curl -X GET http://localhost:3000/test-optional-user \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "message": "–¢–µ—Å—Ç –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞ @OptionalUser()",
  "user": {
    "id": "cce0b3a9-f482-477e-8dda-6b4eb5b7945f",
    "username": "TestUser",
    "email": "test@example.com"
  },
  "isAuthenticated": true
}
```

### 3. –° —Ç–æ–∫–µ–Ω–æ–º –≤ cookie

```bash
curl -X GET http://localhost:3000/test-optional-user \
  -H "Cookie: access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Bearer —Ç–æ–∫–µ–Ω—É.

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –≤—ã–≤–æ–¥–∏—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å:

```
---------------------------------------
request.cookies { access_token: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' }
token eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
---------------------------------------
```

### –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏

1. **"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã —á–µ—Ä–µ–∑ app.get()"**
   - –ü—Ä–æ–±–ª–µ–º–∞ —Å DI –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –º–æ–¥—É–ª–µ

2. **"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å–µ—Ä–≤–∏—Å—ã"**
   - –û–¥–∏–Ω –∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤ (JwtService, ConfigService, UserService) –Ω–µ –Ω–∞–π–¥–µ–Ω
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–æ–¥—É–ª—è

3. **"Error in OptionalUser decorator"**
   - –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–∞ –∏–ª–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

## üßπ –û—á–∏—Å—Ç–∫–∞

–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–¥–∞–ª–∏—Ç–µ —Ç–µ—Å—Ç-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä:

```bash
# –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª
rm src/test-optional-user.controller.ts

# –£–¥–∞–ª–∏—Ç—å –∏–∑ –º–æ–¥—É–ª—è
# –£–±—Ä–∞—Ç—å –∏–º–ø–æ—Ä—Ç –∏ –∏–∑ –º–∞—Å—Å–∏–≤–∞ CONTROLLERS –≤ combine-cached.module.ts
```

## üìù –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö

### Anime Controller

```typescript
@Get()
async findAll(
  @Query() query: GetAnimeListDto,
  @OptionalUser() user: User | null,
) {
  console.log('User from @OptionalUser():', user);
  return await this.animeService.findAll(query, user?.id);
}
```

### Episode Controller

```typescript
@Get(':id')
async findOne(
  @Param() params: UuidParamDto,
  @OptionalUser() user: User | null,
) {
  return await this.episodeService.findOne(params.id, user?.id);
}
```

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ë–µ–∑ —Ç–æ–∫–µ–Ω–∞**: `user` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `null`
2. **–° –≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º**: `user` –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. **–° –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º**: `user` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `null` (–±–µ–∑ –æ—à–∏–±–æ–∫)
4. **–õ–æ–≥–∏**: –î–æ–ª–∂–Ω—ã –≤—ã–≤–æ–¥–∏—Ç—å—Å—è –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ó–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –±—ã—Å—Ç—Ä–æ

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/test-optional-user.controller.ts` - –¢–µ—Å—Ç-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
- `src/common/decorators/optional-user.decorator.ts` - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞
- `src/modules/anime/anime.controller.ts` - –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
